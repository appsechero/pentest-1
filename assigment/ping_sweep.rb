#!/usr/bin/env ruby

########################################
# Perform a simple ping sweep of network
# For 1.4.3-Exercises, question 2
# Usage: ./ping_sweep.rb subnet(192.168.11)
########################################


def usage
	#check the argument	
  if ARGV.length !=1
  	puts "Usage: ./ping_sweep.rb subnet(192.168.79)"
  end
  #match subnet format like 192.168.79
  if /^\d{1,3}\.\d{1,3}\.\d{1,3}$/ =~ ARGV[0]
  	return ARGV[0]
  else
  	puts "wrong subnet format"
  	exit(1)
  end

end

def scan(subnet)

	range = 1..254
	ips = []
	done = []
	range.each do |i|

		ip_address = "#{subnet}.#{i}"
		Thread.new do
			 `ping -q -c1 -W1 #{ip_address}`.split(/\n+/)[2].split(/,\s*/)[1].to_i > 0 and ips << ip_address
			 done << i
		end	
	end

	until done.count == range.count
		print "\r%#{(done.count/range.count.to_f * 100).round}"
		sleep(0.1)
	end
	print "\r"
	puts ips

end



subnet = usage
scan(subnet)



